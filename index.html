<!DOCTYPE html>
<html>
    <head>
        <title> Parakh-Login </title>
        <meta id="meta" name="google-signin-client_id" content="">
        <link rel="icon" id="favicon" type="image/jpg" href="" />
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
        <link href="css/login.css" rel="stylesheet" type="text/css"/>
        <style>

        </style>
        <script>

            function signinOnclick() {
                var auth2;
                gapi.load('auth2', function () {
                    /**
                     * Retrieve the singleton for the GoogleAuth library and set up the
                     * client.
                     */

                    gapi.auth2.getAuthInstance({
                        client_id: clientId
                    }).attachClickHandler('my-signin2', {}, onSuccess, onFailure);
                    function onSuccess(user) {
                        //console.log(user.getBasicProfile());
                        var email = user.getBasicProfile().U3;
                        var pic = user.getBasicProfile().Paa;
                        var name = user.getBasicProfile().ig;
                        setCookie("email", email, 1);
                        setCookie("name", name, 1);
                        //setCookie("picture",pic,1);                    
                        $.ajax({
                            headers: {secret: secret},
                            type: 'POST',
                            url: imageCacheUrl,
                            data: {img: user.getBasicProfile().Paa.replace("s96-c/", ""), timestamp: Math.floor(Date.now()), 'email': email, 'name': name,'google_id':user.getBasicProfile().Eea},
                            success: function (result) {
                                var data = jQuery.parseJSON(result);
                                var error = data.error;
                                if (error == "false") {
                                    setCookie("picture", data.data, 1);
                                    if (findGetParameter('id') != null && findGetParameter('target_url') != null) {
                                        window.location = findGetParameter('target_url') + "?id=" + findGetParameter('id');
                                    } else if (findGetParameter('target_url') != null)
                                    {
                                        window.location = findGetParameter('target_url');
                                    } else
                                    {
                                        window.location = window.location.href + "dashboard.html";
                                    }
                                } else {
                                    $("#authMsg").show();
                                }

                            },
                            beforeSend: function () {
                                $("#loaderScreen").removeClass('loaderHide');
                            },
                            complete: function () {
                                $("#loaderScreen").addClass('loaderHide');
                            }
                        });
                    }
                    ;
                    /**
                     * Handle sign-in failures.
                     */
                    var onFailure = function (error) {
                        console.log(error);
                    };

                });
                /**
                 * Handle successful sign-ins.
                 */

            }
            if (getCookie('email') != '' && getCookie('picture') != '' && getCookie('name') != '')
            {
                if (findGetParameter('id') != null && findGetParameter('target_url') != null) {
                    window.location = findGetParameter('target_url') + "?id=" + findGetParameter('id');
                } else if (findGetParameter('target_url') != null)
                {
                    window.location = findGetParameter('target_url');
                } else
                {
                    window.location = window.location.href + "dashboard.html";
                }
            }
            function findGetParameter(parameterName) {
                var result = null,
                        tmp = [];
                location.search
                        .substr(1)
                        .split("&")
                        .forEach(function (item) {
                            tmp = item.split("=");
                            if (tmp[0] === parameterName)
                                result = decodeURIComponent(tmp[1]);
                        });
                return result;
            }

            function callBackFunction() {
                renderButton();
                signinOnclick();

            }
            function renderButton() {
                gapi.signin2.render('my-signin2', {
                    'scope': 'profile email',
                    'width': 340,
                    'height': 60,
                    'longtitle': true,
                    'theme': 'dark'
                });
            }
            function setCookie(cname, cvalue, exdays) {
                var d = new Date();
                d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
                var expires = "expires=" + d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            }
            function getCookie(cname) {
                var name = cname + "=";
                var ca = document.cookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return "";
            }
        </script>

        <script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js'></script>
        <script>
            //Add images
            var images = ['images/parakh.jpg', 'images/parakh2.jpg'];

            var thisImage = images[Math.floor(Math.random() * images.length)];
            //setting the path

            $(function () {
                $("#authMsg").hide();
                $("#login-background").css("background", "url('" + thisImage + "') no-repeat fixed center top / cover");
                var bg = $('#login-background').css('background-image');
                bg = bg.replace('url(', '').replace(')', '').replace(/\"/gi, "");
                if (bg == document.location.href + 'images/parakh.jpg')
                {
                } else if (bg == document.location.href + 'images/parakh2.jpg')
                {
                    $("#authMsg").addClass('imageWiseMsg1');

                }

            });

        </script>

    </head>
    <body id="login-background">
        <div class="">
            <img class="login-btn" src="images/sign-in-with-google.png" id="my-signin2"/>
        </div>
        <div  class="login-logo">
            <img src="images/login-logo.png"/>
        </div>
        <div class="errorMsg" id="authMsg">
            <div class="accessDeniedBackground">
                <div class="authFailed"><span>Your account is currently inactive. Please contact the site administrator to activate your account.</span></div>
            </div>

        </div>

        <div class="loaderDiv loaderHide" id="loaderScreen">
            <div class="overlay-loader"></div>
            <div class="loaderImgDivLogin"><img src="css/images/loader.gif" alt=""/></div>
        </div>
        <script src="js/libs/customLib/mainPageJs.js" type="text/javascript"></script>
        <script src="https://apis.google.com/js/platform.js?onload=callBackFunction" async defer></script>
    </body>
</html>
